services:
  web:
    image: nginx:latest
    #restart: unless-stopped
    #profiles: [disabled]
    deploy:
      restart_policy: # https://docs.docker.com/reference/compose-file/deploy/#restart_policy
        condition: none
    volumes:
      # tmp DATA_ROOT from .env usage until image isn't built
      - ${DATA_ROOT:-.}/deploy/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      # templates to render environment variables
      #   https://github.com/docker-library/docs/tree/master/nginx#using-environment-variables-in-nginx-configuration-new-in-119
      - ${DATA_ROOT:-.}/deploy/nginx/templates:/etc/nginx/templates:ro
      - ${DATA_ROOT:-.}/pages:/usr/share/nginx/html:ro
      - ${DATA_ROOT:-.}/certbot/www:/var/www/certbot:ro
      - ${DATA_ROOT:-.}/certbot/conf:/etc/letsencrypt:ro
    environment:
      - SERVER_NAME=${SERVER_NAME:-localhost}
    ports:
      # using 'host' mode to simplify diagnostics (correct remote IP)
      #   https://stackoverflow.com/questions/49415595/docker-swarm-get-real-ip-client-host-in-nginx
      # TODO: setup balancer for X-Real-IP
      - mode: host
        protocol: tcp
        published: 80
        target: 80
      - mode: host
        protocol: tcp
        published: 443
        target: 443

  server:
    image: ${SERVER_IMAGE:-server}
    # WebAPI TCP port 8080 is internal as infra NGINX is used
    # WebRTC UDP ports [49152, 65535] are internal as infra TURN is used
